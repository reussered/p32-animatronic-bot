// ST7796 Display Header
// RGB565 (16-bit color)

#ifndef ST7796_HDR
#define ST7796_HDR

#include <cstdint>

// Forward declaration
struct ST7796_Pixel;

// Global InitialPixel - must be set before allocating buffers containing Pixels
extern ST7796_Pixel ST7796_InitialPixel;

/**
 * @brief Pixel struct for ST7796 display (RGB565 format)
 * 16-bit color: 5-6-5 bits
 */
struct ST7796_Pixel
{
    unsigned int red : 5;
    unsigned int green : 6;
    unsigned int blue : 5;
    
    ST7796_Pixel() 
    {
        *this = ST7796_InitialPixel;
    }
    
    // Copy constructor
    ST7796_Pixel(const ST7796_Pixel& other) 
        : red(other.red), green(other.green), blue(other.blue)
    {}
    
    // Assignment operator
    ST7796_Pixel& operator=(const ST7796_Pixel& other)
    {
        red = other.red;
        green = other.green;
        blue = other.blue;
        return *this;
    }

    // Add two pixels with saturation (overflow caps at max value per channel)
    ST7796_Pixel operator+(const ST7796_Pixel& other) const
    {
        ST7796_Pixel result;
        
        // Add red channel (5 bits, max 0x1F = 31)
        unsigned int sum_r = red + other.red;
        result.red = (sum_r > 0x1F) ? 0x1F : sum_r;
        
        // Add green channel (6 bits, max 0x3F = 63)
        unsigned int sum_g = green + other.green;
        result.green = (sum_g > 0x3F) ? 0x3F : sum_g;
        
        // Add blue channel (5 bits, max 0x1F = 31)
        unsigned int sum_b = blue + other.blue;
        result.blue = (sum_b > 0x1F) ? 0x1F : sum_b;
        
        return result;
    }

    // Add-assign operator with saturation
    ST7796_Pixel& operator+=(const ST7796_Pixel& other)
    {
        // Add red channel (5 bits, max 0x1F = 31)
        unsigned int sum_r = red + other.red;
        red = (sum_r > 0x1F) ? 0x1F : sum_r;
        
        // Add green channel (6 bits, max 0x3F = 63)
        unsigned int sum_g = green + other.green;
        green = (sum_g > 0x3F) ? 0x3F : sum_g;
        
        // Add blue channel (5 bits, max 0x1F = 31)
        unsigned int sum_b = blue + other.blue;
        blue = (sum_b > 0x1F) ? 0x1F : sum_b;
        
        return *this;
    }
};

// Display specifications
size_t st7796_get_width(void);
size_t st7796_get_height(void);
size_t getFrameSize(void);
size_t getFrameRowSize(void);
size_t getDisplaySize(void);

// Component functions
esp_err_t st7796_init(void);
void st7796_act(void);

#endif // ST7796_HDR
